-- 08. transactions - integrity

-- 1. 자동 커밋 (autocommit)
-- 자동 커밋 비활성화 (트랜잭션 수동 제어 가능)
SET autocommit = 0;

-- 다시 자동 커밋 ON (기본값)
SET autocommit = 1;



-- 2. 트랜잭션 제어 
-- 1) 트랜잭션 시작 → INSERT → 오류 발생 → ROLLBACK
SET autocommit = 0;
START TRANSACTION;

-- 수강 신청 (ENROLLMENT)
INSERT INTO ENROLLMENT (STUDENT_ID, COURSE_ID, SEMESTER)
VALUES ('20230001', 'CE102', '202401');

SELECT * FROM enrollment WHERE STUDENT_ID = 20230001;

-- 성적 삽입 - 오류 유도 (MID_TERM 점수가 음수 → 제약 위반)
INSERT INTO GRADE (STUDENT_ID, COURSE_ID, MID_TERM, FINAL_TERM)
VALUES ('20230001', 'CE102', -10, 90);

ROLLBACK;

SELECT * FROM enrollment WHERE STUDENT_ID = 20230001;

-- 2) 정상 흐름 → COMMIT → 이후 ROLLBACK 불가
START TRANSACTION;

INSERT INTO ENROLLMENT (STUDENT_ID, COURSE_ID, SEMESTER)
VALUES ('20230001', 'CE102', '202401');

INSERT INTO GRADE (STUDENT_ID, COURSE_ID, MID_TERM, FINAL_TERM)
VALUES ('20230001', 'CE102', 80, 90);

SELECT * FROM enrollment WHERE STUDENT_ID = 20230001;

SELECT * FROM grade WHERE STUDENT_ID = 20230001;

COMMIT;

ROLLBACK;

SELECT * FROM enrollment WHERE STUDENT_ID = 20230001;

SELECT * FROM grade WHERE STUDENT_ID = 20230001;



-- 3. 트랜잭션과 데이터 무결성
START TRANSACTION;

DELETE FROM ATTENDANCE WHERE STUDENT_ID = '20230001';
DELETE FROM GRADE WHERE STUDENT_ID = '20230001';
DELETE FROM ENROLLMENT WHERE STUDENT_ID = '20230001';
DELETE FROM STUDENT WHERE STUDENT_ID = '20230001';

SELECT * FROM student WHERE STUDENT_ID = '20230001';

ROLLBACK; -- 실수했을 경우 모든 작업 되돌리기

SELECT * FROM student WHERE STUDENT_ID = '20230001';










